<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Controle de Calorias</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{font-family:Arial;background:#f6f6f6;padding:16px;margin:0}
h1{color:#ff4d88}
.card{background:#fff;padding:16px;border-radius:8px;margin-bottom:16px}
label{display:block;margin-top:12px;font-weight:bold}
select,input,button{width:100%;padding:8px;margin-top:4px;font-size:16px}
button{background:#ff4d88;color:white;border:none;border-radius:6px;margin-top:16px}
.resumo p {margin:6px 0;}
hr {margin:10px 0;}
</style>
</head>

<body>

<h1>üçé Controle de Calorias</h1>

<div class="card resumo">
  <p><strong>Total di√°rio:</strong> 1510 kcal</p>
  <p>‚úÖ Consumidas: <span id="consumidas">0</span></p>
  <p>üî• Restantes: <span id="restantes">1510</span></p>
  <hr>
  <p>ü•© Prote√≠nas: <span id="prot">0</span> | Faltam: <span id="protFalta">510</span></p>
  <p>üçö Carboidratos: <span id="carb">0</span> | Faltam: <span id="carbFalta">600</span></p>
  <p>ü•ë Gorduras: <span id="gord">0</span> | Faltam: <span id="gordFalta">150</span></p>
  <p>üçé Frutas: <span id="frutas">0</span> | Faltam: <span id="frutasFalta">250</span></p>
</div>

<div class="card">
<label>Data</label>
<input type="date" id="data">

<label>Refei√ß√£o</label>
<select id="refeicao">
<option>Caf√© da manh√£</option>
<option>Almo√ßo</option>
<option>Lanche</option>
<option>Janta</option>
</select>

<label>Categoria</label>
<select id="categoria"></select>

<label>Alimento</label>
<select id="alimento"></select>

<label>Quantidade (em gramas)</label>
<input type="number" id="qtd" placeholder="Informe a quantidade">

<button onclick="salvar()">Salvar</button>
</div>

<script>
const TOTAL_DIARIO = 1510;
const METAS = {
  proteina: 510,
  carbo: 600,
  gordura: 150,
  frutas: 250
};

let total = 0, prot = 0, carb = 0, gordura = 0, frutas = 0;

const SHEET_ID = "1YTMNBLzRi5p-uGSPba2FXsoxMeIWyPif";
const URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=BD`;

let bd = [];

function toNumber(v){
  if(v === null || v === undefined) return 0;
  if(typeof v === "number") return v;
  return Number(String(v).replace(",", "."));
}

fetch(URL)
.then(r => r.text())
.then(t => {
  const j = JSON.parse(t.substring(47).slice(0,-2));
  const rows = j.table.rows;

  bd = rows.map(r => ({
    descricao: r.c[0]?.v || "",
    calorias: toNumber(r.c[1]?.v),
    peso: toNumber(r.c[2]?.v),
    unidade: r.c[3]?.v || "",
    tipo: r.c[4]?.v || ""
  })).filter(a => a.descricao);

  carregarCategorias();
});

function carregarCategorias(){
  const s = document.getElementById("categoria");
  s.innerHTML = "";
  [...new Set(bd.map(a => a.tipo))].forEach(t => {
    const o = document.createElement("option");
    o.text = t;
    s.add(o);
  });
  s.onchange = carregarAlimentos;
  carregarAlimentos();
}

function carregarAlimentos(){
  const cat = document.getElementById("categoria").value;
  const s = document.getElementById("alimento");
  s.innerHTML = "";
  bd.filter(a => a.tipo === cat).forEach(a => {
    const o = document.createElement("option");
    o.text = `${a.descricao} (${a.unidade})`;
    s.add(o);
  });
}

function salvar(){
  const qtd = Number(document.getElementById("qtd").value);
  if(!qtd || qtd <= 0){
    alert("Informe uma quantidade v√°lida");
    return;
  }

  const texto = document.getElementById("alimento").value;
  const alimento = bd.find(a => texto.startsWith(a.descricao));

  if(!alimento){
    alert("Alimento n√£o encontrado");
    return;
  }

  const calorias = qtd * alimento.calorias;
  total += calorias;

  const tipoUpper = alimento.tipo.toUpperCase();

  if(tipoUpper.includes("PROTE")) prot += calorias;
  if(tipoUpper.includes("CARBO")) carb += calorias;
  if(tipoUpper.includes("GORD")) gordura += calorias;
  if(tipoUpper.includes("FRUTA")) frutas += calorias;

  document.getElementById("consumidas").innerText = total.toFixed(1);
  document.getElementById("restantes").innerText = (TOTAL_DIARIO - total).toFixed(1);

  document.getElementById("prot").innerText = prot.toFixed(1);
  document.getElementById("carb").innerText = carb.toFixed(1);
  document.getElementById("gord").innerText = gordura.toFixed(1);
  document.getElementById("frutas").innerText = frutas.toFixed(1);

  document.getElementById("protFalta").innerText = Math.max(METAS.proteina - prot, 0).toFixed(1);
  document.getElementById("carbFalta").innerText = Math.max(METAS.carbo - carb, 0).toFixed(1);
  document.getElementById("gordFalta").innerText = Math.max(METAS.gordura - gordura, 0).toFixed(1);
  document.getElementById("frutasFalta").innerText = Math.max(METAS.frutas - frutas, 0).toFixed(1);

  document.getElementById("qtd").value = "";
}

document.getElementById("data").valueAsDate = new Date();
</script>

</body>
</html>
