<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Controle de Calorias</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{font-family:Arial;background:#f6f6f6;padding:16px;margin:0}
h1{color:#ff4d88}
.card{background:#fff;padding:16px;border-radius:8px;margin-bottom:16px}
label{display:block;margin-top:12px;font-weight:bold}
select,input,button{width:100%;padding:8px;margin-top:4px;font-size:16px}
button{background:#ff4d88;color:white;border:none;border-radius:6px;margin-top:16px}
</style>
</head>

<body>

<h1>üçé Controle de Calorias</h1>

<div class="card">
<strong>Total do dia:</strong> 1510 kcal<br><br>
‚úÖ Consumidas: <strong><span id="consumidas">0</span></strong> kcal<br>
üî• Restantes: <strong><span id="restantes">1510</span></strong> kcal
</div>

<div class="card">
<label>Data</label>
<input type="date" id="data">

<label>Refei√ß√£o</label>
<select id="refeicao">
<option>Caf√© da manh√£</option>
<option>Almo√ßo</option>
<option>Lanche</option>
<option>Janta</option>
</select>

<label>Categoria</label>
<select id="categoria"></select>

<label>Alimento</label>
<select id="alimento"></select>

<label>Quantidade (em gramas)</label>
<input type="number" id="qtd" placeholder="Ex: 150">

<button onclick="salvar()">Salvar</button>
</div>

<script>
const TOTAL_DIARIO = 1510;
let caloriasConsumidasHoje = 0;

const SHEET_ID = "1YTMNBLzRi5p-uGSPba2FXsoxMeIWyPif";
const URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=BD`;

let bd = [];

function toNumber(v){
  if(v === null || v === undefined) return 0;
  if(typeof v === "number") return v;
  return Number(String(v).replace(",", "."));
}

fetch(URL)
.then(r => r.text())
.then(t => {
  const j = JSON.parse(t.substring(47).slice(0,-2));
  const rows = j.table.rows;

  bd = rows.map(r => ({
    descricao: r.c[0]?.v || "",
    calorias: toNumber(r.c[1]?.v),
    peso: toNumber(r.c[2]?.v),
    unidade: r.c[3]?.v || "",
    tipo: r.c[4]?.v || ""
  })).filter(a => a.descricao);

  carregarCategorias();
});

function carregarCategorias(){
  const s = document.getElementById("categoria");
  s.innerHTML = "";
  [...new Set(bd.map(a => a.tipo))].forEach(t => {
    const o = document.createElement("option");
    o.text = t;
    s.add(o);
  });
  s.onchange = carregarAlimentos;
  carregarAlimentos();
}

function carregarAlimentos(){
  const cat = document.getElementById("categoria").value;
  const s = document.getElementById("alimento");
  s.innerHTML = "";
  bd.filter(a => a.tipo === cat).forEach(a => {
    const o = document.createElement("option");
    o.text = `${a.descricao} (${a.unidade})`;
    s.add(o);
  });
}

function salvar(){
  const qtd = Number(document.getElementById("qtd").value);
  if(!qtd || qtd <= 0){
    alert("Informe uma quantidade v√°lida");
    return;
  }

  const texto = document.getElementById("alimento").value;
  const alimento = bd.find(a => texto.startsWith(a.descricao));

  if(!alimento){
    alert("Alimento n√£o encontrado");
    return;
  }

  const calorias = qtd * alimento.calorias;
  caloriasConsumidasHoje += calorias;

  document.getElementById("consumidas").innerText =
    caloriasConsumidasHoje.toFixed(1);

  document.getElementById("restantes").innerText =
    (TOTAL_DIARIO - caloriasConsumidasHoje).toFixed(1);

  document.getElementById("qtd").value = "";

  alert(`‚úÖ Salvo!
${alimento.descricao}
Calorias: ${calorias.toFixed(1)} kcal`);
}

document.getElementById("data").valueAsDate = new Date();
</script>

</body>
</html>
